<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />

<style>
body {
margin: 0px;
}
</style>

<script src="../../js/three.min.js"></script>

<script src="../../js/loaders/ColladaLoader.js"></script>
<script src="../../js/renderers/CanvasRenderer.js"></script>
<script src="../../js/renderers/Projector.js"></script>
<script src="../../js/controls/OrbitControls.js"></script>
<script src="../../js/Detector.js"></script>
<script src="../../js/sketch.js"></script>

<!-- <script src="http://cdn.robotwebtools.org/threejs/current/three.min.js"></script> -->

<script src="http://cdn.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
<script src="http://cdn.robotwebtools.org/roslibjs/current/roslib.min.js"></script>
<script src="../../js/ros3d.js"></script>

<script src="../../js/marker_msg_6dof.js"></script>

<script src="solver.js"></script>
<script src="../../js/ik.js"></script>

<!-- <script src="http://cdn.robotwebtools.org/threejs/r61/ColladaLoader.js"></script> -->

<script>
  var ros, viewer, marker_client;

  var dae;
  var collada;

  var kinematics;
  var kinematicsTween;
  var tweenParameters = {};

  var loader = new THREE.ColladaLoader();
  loader.options.convertUpAxis = true;
  loader.load( '../../models/pr2/collada/openrave-pr2.dae', function ( collada_ ) {

      collada = collada_;
      dae = collada.scene;

      dae.traverse( function ( child ) {

          if ( child instanceof THREE.Mesh ) {

              child.geometry.computeFaceNormals();
              child.material.shading = THREE.FlatShading;

          }

      } );

      dae.scale.x = dae.scale.y = dae.scale.z = 10.0;
      dae.updateMatrix();

      kinematics = collada.kinematics;

      init();

  } );

  function getControlPoints(obj) {
      var x_offset = new THREE.Vector3(1, 0, 0);
      var y_offset = new THREE.Vector3(0, 1, 0);
      var points = [
        obj.position,
        obj.position.clone().add(x_offset.applyQuaternion(obj.quaternion)),
        obj.position.clone().add(y_offset.applyQuaternion(obj.quaternion))
      ]
      return points;
  }

  function stopPropagation(event) {
    event.stopPropagation();
  }

  function init() {
    viewer = new ROS3D.Viewer({
      divID : 'markers',
      width : window.innerWidth,
      height : window.innerHeight,
      antialias : true,
      background:  '#cccccc'
    });

    marker_client = new ROS3D.InteractiveMarkerClient({
      pure_client_side : true,
      camera : viewer.camera,
      rootObject : viewer.selectableObjects
    });

    marker_client.processUpdate({markers:[marker_msg], erases:[], poses:[]});
    marker_obj = marker_client.rootObject.children[0];

    // Add a grid.
    viewer.addObject(new ROS3D.Grid({color: '#999999'}));

    // Add robot
    dae.applyMatrix((new THREE.Matrix4).makeRotationX(Math.PI/2))
    dae.scale.multiplyScalar(0.3);
    viewer.addObject( dae, true );

    // Messy stuff for initalizing IK
    dae.addEventListener('mousedown', function (event) { console.log('robot mousedown'); });
    dae.addEventListener('mouseup', function (event) { console.log('robot mouseup'); });
    dae.addEventListener('mouseover', stopPropagation);
    dae.addEventListener('mouseout', stopPropagation);
    dae.addEventListener('click', stopPropagation);
    dae.addEventListener('mousedown', stopPropagation);
    dae.addEventListener('mouseup', stopPropagation);
    camera = viewer.camera;
    renderer = viewer.renderer;
    linkToIndex = {};
    dragging_object = false;
    arm_link_name = 'l_shoulder_pan_link';
    arm_joint_idx = findJointByName(arm_link_name);
    solver = new Module.IKSolver;
    raycaster = new THREE.Raycaster();
    cursor = new THREE.Vector2( -200, -200 );
    cursor_normalized = new THREE.Vector2( -200, -200 );
    drag_point = new THREE.Vector3( 0, 0, 0);
    projected_point = new THREE.Vector2( -200, -200 );
    // Create the drag point dot
    var material = new THREE.MeshBasicMaterial( { color: 0x000000 } );
    var geometry = new THREE.SphereGeometry(0.01);
    drag_point_visual = new THREE.Mesh( geometry, material );
    drag_point_visual.visible = false;
    // Add solver callback
    viewer.addDrawCallback(function () {
      if (dragging_object) {
        solveIK();
      }
    });
    // IK callbacks
    document.addEventListener('mousedown', handleMouseDown);
    document.addEventListener('mouseup', handleMouseUp);
    document.addEventListener('mousemove', function(event) {
        // calculate mouse position in normalized device coordinates
        // (-1 to +1) for both components
        cursor_normalized.x = ( event.x / window.innerWidth ) * 2 - 1;
        cursor_normalized.y = - ( event.y / window.innerHeight ) * 2 + 1;
        cursor.x = event.x;
        cursor.y = event.y;
    });
}
</script>
</head>
<!-- <body onload="init()"> -->
<body>
  <div id="markers"></div>
  <!-- <script> init(); </script> -->
</body>
</html>
